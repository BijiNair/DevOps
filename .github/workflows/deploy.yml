name: CI/CD - Docker + Terraform + ECR

on:
  workflow_dispatch:        # Manual trigger
  push:
    branches: [ "main" ]    # Auto-run on push to main

jobs:
  build_push_and_terraform:
    runs-on: ubuntu-latest

    steps:

      # -------------------------
      # CHECKOUT
      # -------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------
      # AWS CREDENTIALS
      # -------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # -------------------------
      # LOGIN TO ECR
      # -------------------------
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # -------------------------
      # DOCKER BUILD
      # -------------------------
      - name: Build Docker image
        run: |
          docker build -t myapp myapp/app

      # -------------------------
      # TAG IMAGE FOR ECR
      # -------------------------
      - name: Tag image for ECR
        run: |
          ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG=latest
          docker tag myapp:latest $ECR_REGISTRY/myapp:$IMAGE_TAG

      # -------------------------
      # PUSH IMAGE TO ECR
      # -------------------------
      - name: Push image to ECR
        run: |
          ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG=latest
          docker push $ECR_REGISTRY/myapp:$IMAGE_TAG

      # -------------------------
      # TERRAFORM SETUP
      # -------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      # -------------------------
      # TERRAFORM INIT
      # -------------------------
      - name: Terraform Init
        working-directory: myapp/app/terraform
        run: terraform init

      # -------------------------
      # IMPORT EXISTING IAM RESOURCES (if present)
      # -------------------------
      - name: Terraform Import existing IAM resources
        working-directory: myapp/app/terraform
        run: |
          # Ensure initialized
          terraform init
          # export required variables so import/terraform commands don't error on missing vars
          export TF_VAR_ecr_repository_url="${{ steps.login-ecr.outputs.registry }}/myapp"
          export TF_VAR_subnet_id="${{ secrets.SUBNET_ID }}"

          # Fail on unexpected errors, but allow import to fail if resource already present
          set -e

          echo "Checking Terraform state for aws_iam_role.ec2_role..."
          if ! terraform state list | grep -xq 'aws_iam_role.ec2_role'; then
            echo "Importing existing IAM role ec2_ecr_pull_role into terraform state..."
            terraform import aws_iam_role.ec2_role ec2_ecr_pull_role || true
          else
            echo "aws_iam_role.ec2_role already in state, skipping import."
          fi

          echo "Checking Terraform state for aws_iam_instance_profile.ec2_profile..."
          if ! terraform state list | grep -xq 'aws_iam_instance_profile.ec2_profile'; then
            echo "Importing existing instance profile ec2_ecr_profile into terraform state..."
            terraform import aws_iam_instance_profile.ec2_profile ec2_ecr_profile || true
          else
            echo "aws_iam_instance_profile.ec2_profile already in state, skipping import."
          fi

          echo "Checking Terraform state for aws_iam_role_policy.ecr_policy..."
          if ! terraform state list | grep -xq 'aws_iam_role_policy.ecr_policy'; then
            echo "Importing inline role policy ecr_policy into terraform state..."
            terraform import aws_iam_role_policy.ecr_policy ec2_ecr_pull_role/ecr_policy || true
          else
            echo "aws_iam_role_policy.ecr_policy already in state, skipping import."
          fi

          echo "Checking for existing security group named 'ec2_sg_tf'..."
          SG_ID=$(aws ec2 describe-security-groups --filters "Name=group-name,Values=ec2_sg_tf" --query 'SecurityGroups[0].GroupId' --output text || true)
          if [ -n "$SG_ID" ] && [ "$SG_ID" != "None" ]; then
            echo "Found security group id: $SG_ID - attempting import into terraform state..."
            if ! terraform state list | grep -xq 'aws_security_group.ec2_sg_tf'; then
              terraform import aws_security_group.ec2_sg_tf $SG_ID || true
            else
              echo "aws_security_group.ec2_sg_tf already in state, skipping import."
            fi
          else
            echo "No security group named 'ec2_sg_tf' found in the account; skipping import."
          fi

      # -------------------------
      # TERRAFORM PLAN
      # -------------------------
      - name: Terraform Plan
        working-directory: myapp/app/terraform
        run: |
          terraform plan \
            -var="ecr_repository_url=${{ steps.login-ecr.outputs.registry }}/myapp" \
            -var="subnet_id=${{ secrets.SUBNET_ID }}" \
            -out=tfplan

      # -------------------------
      # TERRAFORM APPLY
      # -------------------------
      - name: Terraform Apply
        working-directory: myapp/app/terraform
        run: |
          terraform apply \
            -var="ecr_repository_url=${{ steps.login-ecr.outputs.registry }}/myapp" \
            -var="subnet_id=${{ secrets.SUBNET_ID }}" \
            -auto-approve tfplan
